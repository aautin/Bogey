name: Build and Release Executables

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Conan
        run: pip install conan
      - name: Conan install
        run: conan install . --build=missing
      - name: Configure and Build
        run: |
          cmake --preset x64-release
          cmake --build --preset x64-release
      - name: Upload Windows Executable
        uses: actions/upload-artifact@v4
        with:
          name: windows-exe
          path: out/build/x64-release/Bogey.exe

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Conan
        run: pip install conan
      - name: Conan install
        run: conan install . --build=missing
      - name: Configure and Build
        run: |
          cmake --preset linux-debug -DCMAKE_BUILD_TYPE=Release
          cmake --build --preset linux-debug
      - name: Upload Linux Executable
        uses: actions/upload-artifact@v4
        with:
          name: linux-exe
          path: out/build/linux-debug/Bogey

  release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Download Windows Executable
        uses: actions/download-artifact@v4
        with:
          name: windows-exe
          path: artifacts/
      - name: Download Linux Executable
        uses: actions/download-artifact@v4
        with:
          name: linux-exe
          path: artifacts/
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Release ${{ github.run_number }}
          files: artifacts/*